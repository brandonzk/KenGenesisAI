<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品文档处理 - 中意赵珂保险AI智能引擎</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="common.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #000000;
            --secondary-color: #1d1d1f;
            --accent-color: #007aff;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(0, 0, 0, 0.8);
            --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --success-color: #30d158;
            --warning-color: #ff9f0a;
            --error-color: #ff453a;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-color);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .page-banner {
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1)),
                        url('中意人寿/中意产品介绍/banner/Appeal for Unblocking Account (23).png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-bottom: 0;
        }
        
        .banner-content {
            z-index: 2;
            color: white;
            max-width: 800px;
            padding: 0 20px;
        }
        
        .banner-title {
            font-size: clamp(3.5rem, 10vw, 7rem);
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #ffffff, #a1a1a6, #007aff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            letter-spacing: -0.02em;
            text-shadow: none;
        }
        
        .banner-subtitle {
            font-size: clamp(1.4rem, 4vw, 2.2rem);
            color: var(--text-secondary);
            margin-bottom: 50px;
            font-weight: 400;
            line-height: 1.4;
            opacity: 1;
            text-shadow: none;
        }
        
        .banner-description {
            font-size: 1.2rem;
            line-height: 1.6;
            opacity: 0.8;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .page-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.6));
            z-index: 1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #ffffff, #a1a1a6, #007aff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }
        
        .back-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 20px;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            backdrop-filter: blur(20px);
            z-index: 1000;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
        }
        
        .control-panel {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .process-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .process-btn:hover:not(:disabled) {
            background: #0056cc;
            transform: translateY(-2px);
        }
        
        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-info {
            flex: 1;
            min-width: 200px;
        }
        
        .status-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #0056cc);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .module-section {
            margin-bottom: 40px;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }
        
        .module-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .module-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-upload {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-upload:hover {
            background: #28a745;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-danger:hover {
            background: #dc3545;
            transform: translateY(-1px);
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .document-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(20px);
            transition: var(--transition);
            position: relative;
        }
        
        .document-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }
        
        .document-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .document-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-color), #0056cc);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .document-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }
        
        .document-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: rgba(255, 159, 10, 0.2);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }
        
        .status-processing {
            background: rgba(0, 122, 255, 0.2);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }
        
        .status-completed {
            background: rgba(48, 209, 88, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .status-error {
            background: rgba(255, 69, 58, 0.2);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        
        .document-info {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .document-preview {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            font-size: 13px;
            color: var(--text-secondary);
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .document-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        }
        
        .document-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--text-primary);
        }
        
        .btn-delete {
            border-color: var(--error-color) !important;
            color: var(--error-color) !important;
        }
        
        .btn-delete:hover {
            background: var(--error-color) !important;
            color: white !important;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-style: italic;
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            max-width: 80vw;
            max-height: 80vh;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            flex: 1;
            color: var(--text-primary);
        }
        
        .category-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .btn-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-body pre {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }
        
        .processing-log {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            display: none;
        }
        
        .processing-log.show {
            display: block;
        }
        
        .log-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .log-content {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            display: flex;
            gap: 10px;
        }
        
        .log-time {
            color: var(--text-secondary);
            min-width: 80px;
        }
        
        .log-message {
            color: var(--text-primary);
        }
        
        .log-error {
            color: var(--error-color);
        }
        
        .log-success {
            color: var(--success-color);
        }
        
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            color: var(--text-primary);
            backdrop-filter: blur(20px);
            z-index: 1002;
            transform: translateX(400px);
            transition: var(--transition);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-color: var(--success-color);
        }
        
        .notification.error {
            border-color: var(--error-color);
        }
        
        /* 底部版权信息样式 */
        .footer {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            margin-top: 50px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .footer-content {
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .footer-content p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 0;
        }
        
        .settings-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(20px);
            z-index: 100;
            min-width: 350px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .settings-panel.show {
            display: block;
            transform: translateX(0);
        }
        

        
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            z-index: 101;
            transition: all 0.3s ease;
        }
        
        .settings-toggle:hover {
            transform: scale(1.1);
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-group:last-child {
            margin-bottom: 0;
        }
        
        .setting-label {
            display: block;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .setting-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .brightness-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: -1;
            transition: opacity 0.3s ease;
        }
        

        
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .process-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <script>
        // 设置随机背景图片
        document.addEventListener('DOMContentLoaded', function() {
            if (window.backgroundImages && window.backgroundImages.length > 0) {
                const randomImage = window.backgroundImages[Math.floor(Math.random() * window.backgroundImages.length)];
                const banner = document.querySelector('.page-banner');
                banner.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('${randomImage}')`;
            }
        });
    </script>
    <div class="page-banner">
        <div class="banner-content">
            <h1 class="banner-title">Document Processing</h1>
            <p class="banner-subtitle">产品文档处理</p>
            <p class="banner-description">智能解析产品文档，自动提取核心信息，让复杂资料变得清晰易懂</p>
        </div>
    </div>
    
    <!-- 亮度调节遮罩 -->
    <div class="brightness-overlay" id="brightnessOverlay"></div>
    
    <!-- 设置按钮 -->
    <button class="settings-toggle" onclick="toggleSettings()" title="设置">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="setting-group">
            <label class="setting-label">背景亮度</label>
            <input type="range" id="brightnessSlider" min="0" max="100" value="50" onchange="adjustBrightness()" class="setting-input">
            <span id="brightnessValue">50%</span>
        </div>
        
        <div class="setting-group">
            <button class="btn-danger" onclick="resetSettings()">重置设置</button>
        </div>
    </div>
    
    <a href="/" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>返回主页</span>
    </a>
    
    <div class="container">
        
        <div class="control-panel">
            <button class="process-btn" onclick="refreshDocuments()" id="refreshBtn">
                <i class="fas fa-sync"></i>
                <span>刷新文档列表</span>
            </button>
            
            <button class="process-btn" onclick="startProcessing()" id="processBtn">
                <i class="fas fa-cogs"></i>
                <span>批量处理文档</span>
            </button>
            
            <div class="status-info">
                <div class="status-text" id="statusText">准备就绪</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
        
        <!-- 产品说明模块 -->
        <div class="module-section">
            <div class="module-header">
                <h2><i class="fas fa-file-alt"></i> 产品说明文档</h2>
                <div class="module-actions">
                    <input type="file" id="productSpecUpload" accept=".md,.txt,.pdf" multiple style="display: none;" onchange="handleFileUpload('productSpecs')">
                    <button class="btn-upload" onclick="document.getElementById('productSpecUpload').click()">
                        <i class="fas fa-upload"></i> 上传产品说明
                    </button>
                    <button class="btn-danger" onclick="clearCategory('productSpecs')">
                        <i class="fas fa-trash"></i> 清空分类
                    </button>
                </div>
            </div>
            <div class="documents-grid" id="productSpecsGrid">
                <!-- 产品说明文档卡片 -->
            </div>
        </div>
        
        <!-- 销售话术模块 -->
        <div class="module-section">
            <div class="module-header">
                <h2><i class="fas fa-comments"></i> 销售话术文档</h2>
                <div class="module-actions">
                    <input type="file" id="salesScriptUpload" accept=".md,.txt,.pdf" multiple style="display: none;" onchange="handleFileUpload('salesScripts')">
                    <button class="btn-upload" onclick="document.getElementById('salesScriptUpload').click()">
                        <i class="fas fa-upload"></i> 上传销售话术
                    </button>
                    <button class="btn-danger" onclick="clearCategory('salesScripts')">
                        <i class="fas fa-trash"></i> 清空分类
                    </button>
                </div>
            </div>
            <div class="documents-grid" id="salesScriptsGrid">
                <!-- 销售话术文档卡片 -->
            </div>
        </div>
        
        <div class="processing-log" id="processingLog">
            <h2 class="log-title">
                <i class="fas fa-terminal"></i>
                处理日志
            </h2>
            <div class="log-content" id="logContent">
                <!-- 日志内容将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <!-- 底部版权信息 -->
    <!-- 底部版权信息 -->
    <footer class="footer">
        <div class="footer-content">
            <p>Copyright © 2025 Document Processing. All rights reserved by 赵珂</p>
        </div>
    </footer>
    
    <script>
        let apiConfig = {
            apiKey: localStorage.getItem('deepseek_api_key') || '',
            baseUrl: localStorage.getItem('api_base_url') || 'https://api.deepseek.com',
            model: localStorage.getItem('model_name') || 'deepseek-chat'
        };
        
        // 产品文档配置
        const DOCUMENT_BASE_PATH = '中意人寿/中意产品介绍/zhongyi';
        
        // 产品文档分类管理
        const documentCategories = {
            productSpecs: {
                name: '产品说明',
                icon: 'fa-file-alt',
                documents: []
            },
            salesScripts: {
                name: '销售话术',
                icon: 'fa-comments',
                documents: []
            }
        };
        
        // 从本地文件夹动态加载文档列表
        let allDocuments = [];
        
        let isProcessing = false;
        let processedCount = 0;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (!apiConfig.apiKey) {
                showNotification('请先在主页配置API密钥', 'error');
            }
            loadDocumentCategories();
            refreshDocuments();
        });
        
        // 加载文档分类数据
        function loadDocumentCategories() {
            const saved = localStorage.getItem('document_categories');
            if (saved) {
                const savedCategories = JSON.parse(saved);
                Object.assign(documentCategories, savedCategories);
            }
        }
        
        // 保存文档分类数据
        function saveDocumentCategories() {
            localStorage.setItem('document_categories', JSON.stringify(documentCategories));
        }
        
        // 刷新文档列表
        async function refreshDocuments() {
            addLog('开始刷新文档列表...', 'info');
            
            try {
                // 尝试从指定路径读取文档列表
                await loadDocumentsFromPath();
                renderAllDocuments();
                addLog('文档列表刷新完成', 'success');
                showNotification('文档列表已刷新', 'success');
            } catch (error) {
                addLog(`刷新失败: ${error.message}`, 'error');
                showNotification('刷新失败: ' + error.message, 'error');
                // 即使刷新失败，也要渲染已有的文档
                renderAllDocuments();
            }
        }
        
        // 从路径加载文档
        async function loadDocumentsFromPath() {
            try {
                addLog('正在从指定路径加载文档...', 'info');
                
                // 指定的文档路径
                const documentPath = '中意人寿/中意产品介绍/zhongyi';
                
                // 模拟从指定路径读取的中意人寿产品文档
                const zhongyiDocuments = [
                    // 产品说明文档
                    { name: '中意乐安馨医疗保险-条款.pdf', category: 'productSpecs', type: 'pdf', size: 2048000 },
                    { name: '中意乐优享（全能版）医疗保险（费率可调）-条款.pdf', category: 'productSpecs', type: 'pdf', size: 1856000 },
                    { name: '中意多岁守护护理保险-条款.pdf', category: 'productSpecs', type: 'pdf', size: 1792000 },
                    { name: '中意一生挚爱（荣耀版）终身寿险（分红型）-条款.pdf', category: 'productSpecs', type: 'pdf', size: 2304000 },
                    { name: '中意意心守护（惠选版）重大疾病保险-条款.pdf', category: 'productSpecs', type: 'pdf', size: 2176000 },
                    { name: '中意悠然安养养老年金保险（分红型）-条款.pdf', category: 'productSpecs', type: 'pdf', size: 1920000 },
                    { name: '中意悠然颐养两全保险（分红型）-条款.pdf', category: 'productSpecs', type: 'pdf', size: 1984000 },
                    
                    // 产品说明书
                    { name: '中意多岁守护护理保险-产品说明书.pdf', category: 'productSpecs', type: 'pdf', size: 1536000 },
                    { name: '中意意心守护（惠选版）重大疾病保险-产品说明书.pdf', category: 'productSpecs', type: 'pdf', size: 1472000 },
                    { name: '中意乐安馨医疗保险-产品说明书.pdf', category: 'productSpecs', type: 'pdf', size: 1408000 },
                    { name: '中意乐优享（全能版）医疗保险（费率可调）-产品说明书.pdf', category: 'productSpecs', type: 'pdf', size: 1344000 },
                    { name: '中意一生挚爱（荣耀版）终身寿险（分红型）-产品说明书.pdf', category: 'productSpecs', type: 'pdf', size: 1600000 },
                    { name: '中意悠然安养养老年金保险（分红型）-产品说明书.pdf', category: 'productSpecs', type: 'pdf', size: 1280000 },
                    { name: '中意悠然颐养两全保险（分红型）-产品说明书.pdf', category: 'productSpecs', type: 'pdf', size: 1216000 },
                    
                    // 销售话术文档
                    { name: '中意医疗保险销售话术.md', category: 'salesScripts', type: 'md', size: 512000 },
                    { name: '中意重疾保险销售话术.md', category: 'salesScripts', type: 'md', size: 480000 },
                    { name: '中意寿险产品销售话术.md', category: 'salesScripts', type: 'md', size: 448000 },
                    { name: '中意养老保险销售话术.md', category: 'salesScripts', type: 'md', size: 416000 }
                ];
                
                // 清空现有文档
                documentCategories.productSpecs.documents = [];
                documentCategories.salesScripts.documents = [];
                
                // 将文档添加到对应分类
                zhongyiDocuments.forEach(doc => {
                    const fullPath = `${documentPath}/${doc.name}`;
                    
                    if (!documentCategories[doc.category].documents) {
                        documentCategories[doc.category].documents = [];
                    }
                    
                    documentCategories[doc.category].documents.push({
                        name: doc.name,
                        file: doc.name,
                        path: fullPath,
                        type: doc.type,
                        size: doc.size,
                        status: 'pending',
                        uploadedAt: new Date().toISOString(),
                        content: null // 需要时从服务器读取
                    });
                });
                
                saveDocumentCategories();
                 renderAllDocuments();
                 
                 const totalDocs = zhongyiDocuments.length;
                 const productCount = documentCategories.productSpecs.documents.length;
                 const salesCount = documentCategories.salesScripts.documents.length;
                 addLog(`已从路径 "${documentPath}" 加载 ${totalDocs} 个中意人寿产品文档（产品说明：${productCount}个，销售话术：${salesCount}个）`, 'success');
                
            } catch (error) {
                console.error('加载文档失败:', error);
                addLog('加载文档失败: ' + error.message, 'error');
                throw error;
            }
        }
        
        // 渲染所有文档
        function renderAllDocuments() {
            renderCategoryDocuments('productSpecs', 'productSpecsGrid');
            renderCategoryDocuments('salesScripts', 'salesScriptsGrid');
            updateStatus();
        }
        
        // 渲染分类文档
        function renderCategoryDocuments(category, gridId) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            
            const categoryData = documentCategories[category];
            if (!categoryData || !categoryData.documents) {
                grid.innerHTML = '<div class="empty-state">暂无文档，请上传文档文件</div>';
                return;
            }
            
            categoryData.documents.forEach((doc, index) => {
                const card = document.createElement('div');
                card.className = 'document-card';
                card.innerHTML = `
                    <div class="document-header">
                        <div class="document-icon">
                            <i class="fas ${categoryData.icon}"></i>
                        </div>
                        <div class="document-title">${doc.name}</div>
                        <div class="document-status ${getStatusClass(doc.status)}" id="status-${category}-${index}">${getStatusText(doc.status)}</div>
                    </div>
                    <div class="document-info">
                        类型：${categoryData.name} | 文件：${doc.file} | 大小：${formatFileSize(doc.size || 0)}
                    </div>
                    <div class="document-preview" id="preview-${category}-${index}">
                        ${doc.preview || '点击"查看原文"来查看文档内容...'}
                    </div>
                    <div class="document-actions">
                        <button class="btn-small" onclick="viewDocument('${category}', ${index})">
                            <i class="fas fa-eye"></i>
                            查看原文
                        </button>
                        <button class="btn-small" onclick="processDocument('${category}', ${index})">
                            <i class="fas fa-cogs"></i>
                            处理文档
                        </button>
                        <button class="btn-small" onclick="downloadProcessed('${category}', ${index})">
                            <i class="fas fa-download"></i>
                            下载结果
                        </button>
                        <button class="btn-small btn-delete" onclick="deleteDocument('${category}', ${index})">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // 获取状态样式类
        function getStatusClass(status) {
            const classes = {
                'pending': 'status-pending',
                'processing': 'status-processing',
                'completed': 'status-completed',
                'error': 'status-error'
            };
            return classes[status] || 'status-pending';
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const texts = {
                'pending': '待处理',
                'processing': '处理中',
                'completed': '已完成',
                'error': '处理失败'
            };
            return texts[status] || '待处理';
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 处理文件上传
        async function handleFileUpload(category) {
            const input = document.getElementById(category === 'productSpecs' ? 'productSpecUpload' : 'salesScriptUpload');
            const files = input.files;
            
            if (files.length === 0) return;
            
            addLog(`开始上传 ${files.length} 个文件到 ${documentCategories[category].name}`, 'info');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    await uploadFile(category, file);
                    addLog(`文件上传成功: ${file.name}`, 'success');
                } catch (error) {
                    addLog(`文件上传失败: ${file.name} - ${error.message}`, 'error');
                }
            }
            
            // 清空文件输入
            input.value = '';
            
            // 重新渲染文档列表
            renderAllDocuments();
            saveDocumentCategories();
            showNotification('文件上传完成', 'success');
        }
        
        // 上传单个文件
        async function uploadFile(category, file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    const doc = {
                        name: file.name.replace(/\.[^/.]+$/, ""), // 移除文件扩展名
                        file: file.name,
                        content: content,
                        size: file.size,
                        uploadedAt: new Date().toISOString(),
                        status: 'pending',
                        preview: content.substring(0, 200) + '...'
                    };
                    
                    if (!documentCategories[category].documents) {
                        documentCategories[category].documents = [];
                    }
                    
                    documentCategories[category].documents.push(doc);
                    resolve(doc);
                };
                
                reader.onerror = function() {
                    reject(new Error('文件读取失败'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // 删除文档
        function deleteDocument(category, index) {
            if (!confirm('确定要删除这个文档吗？')) {
                return;
            }
            
            const categoryData = documentCategories[category];
            if (categoryData && categoryData.documents && categoryData.documents[index]) {
                const doc = categoryData.documents[index];
                categoryData.documents.splice(index, 1);
                
                saveDocumentCategories();
                renderAllDocuments();
                
                addLog(`文档已删除: ${doc.name}`, 'info');
                showNotification('文档已删除', 'success');
            }
        }
        
        // 清空分类
        function clearCategory(category) {
            const categoryName = documentCategories[category].name;
            if (!confirm(`确定要清空所有${categoryName}文档吗？此操作不可恢复！`)) {
                return;
            }
            
            documentCategories[category].documents = [];
            saveDocumentCategories();
            renderAllDocuments();
            
            addLog(`已清空${categoryName}分类`, 'info');
            showNotification(`${categoryName}分类已清空`, 'success');
        }
        
        // 批量处理所有文档
        async function startProcessing() {
            if (!apiConfig.apiKey) {
                showNotification('请先配置API密钥', 'error');
                return;
            }
            
            if (isProcessing) {
                showNotification('正在处理中，请稍候...', 'warning');
                return;
            }
            
            // 统计所有待处理文档
            let totalDocs = 0;
            Object.keys(documentCategories).forEach(category => {
                if (documentCategories[category].documents) {
                    totalDocs += documentCategories[category].documents.filter(doc => doc.status === 'pending').length;
                }
            });
            
            if (totalDocs === 0) {
                showNotification('没有待处理的文档', 'warning');
                return;
            }
            
            isProcessing = true;
            processedCount = 0;
            
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>批量处理中...</span>';
            
            document.getElementById('processingLog').classList.add('show');
            addLog(`开始批量处理 ${totalDocs} 个文档...`, 'info');
            
            try {
                // 处理所有分类的文档
                for (const category of Object.keys(documentCategories)) {
                    const categoryData = documentCategories[category];
                    if (categoryData.documents) {
                        for (let i = 0; i < categoryData.documents.length; i++) {
                            if (categoryData.documents[i].status === 'pending') {
                                await processDocument(category, i);
                                processedCount++;
                                updateProgress(processedCount / totalDocs * 100);
                            }
                        }
                    }
                }
                
                addLog('所有文档处理完成！', 'success');
                showNotification('批量处理完成', 'success');
                updateProductDatabase();
            } catch (error) {
                addLog(`批量处理失败: ${error.message}`, 'error');
                showNotification('批量处理失败: ' + error.message, 'error');
            } finally {
                isProcessing = false;
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-cogs"></i><span>批量处理文档</span>';
                updateStatus('处理完成');
            }
        }
        
        // 处理单个文档
        async function processDocument(category, index) {
            const categoryData = documentCategories[category];
            const doc = categoryData.documents[index];
            const statusEl = document.getElementById(`status-${category}-${index}`);
            const previewEl = document.getElementById(`preview-${category}-${index}`);
            
            try {
                // 更新状态为处理中
                doc.status = 'processing';
                statusEl.className = 'document-status status-processing';
                statusEl.textContent = '处理中';
                addLog(`开始处理: ${doc.name}`, 'info');
                
                // 使用已上传的文件内容或尝试从路径读取
                let fileContent = doc.content;
                if (!fileContent) {
                    fileContent = await readDocumentFile(doc.file);
                    addLog(`文件读取完成: ${doc.file}`, 'info');
                } else {
                    addLog(`使用已上传的文件内容: ${doc.file}`, 'info');
                }
                
                // 调用AI进行文档处理
                const processedContent = await processWithAI(doc.name, fileContent, categoryData.name);
                addLog(`AI处理完成: ${doc.name}`, 'success');
                
                // 保存处理结果
                doc.processedContent = processedContent;
                doc.processedAt = new Date().toISOString();
                doc.status = 'completed';
                
                // 更新预览
                previewEl.textContent = processedContent.substring(0, 200) + '...';
                
                // 更新状态为完成
                statusEl.className = 'document-status status-completed';
                statusEl.textContent = '已完成';
                
                // 保存到本地存储
                saveDocumentCategories();
                
            } catch (error) {
                addLog(`处理失败: ${doc.name} - ${error.message}`, 'error');
                doc.status = 'error';
                statusEl.className = 'document-status status-error';
                statusEl.textContent = '处理失败';
                previewEl.textContent = '处理失败: ' + error.message;
                saveDocumentCategories();
            }
        }
        
        // 读取文档文件
        async function readDocumentFile(filename) {
            try {
                // 尝试多个可能的文件路径
                const possiblePaths = [
                    `中意人寿/中意产品介绍/zhongyi/${filename}`,
                    `/中意人寿/中意产品介绍/zhongyi/${filename}`,
                    `./中意人寿/中意产品介绍/zhongyi/${filename}`,
                    `../中意人寿/中意产品介绍/zhongyi/${filename}`,
                    `docs/${filename}`,
                    `./docs/${filename}`
                ];
                
                for (const path of possiblePaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            const content = await response.text();
                            addLog(`成功从路径读取文件: ${path}`, 'success');
                            return content;
                        }
                    } catch (pathError) {
                        console.log(`路径 ${path} 读取失败:`, pathError.message);
                    }
                }
                
                throw new Error(`所有路径都无法读取文件: ${filename}`);
            } catch (error) {
                console.error(`读取文件 ${filename} 失败:`, error);
                addLog(`文件读取失败: ${filename} - ${error.message}`, 'error');
                // 如果文件读取失败，返回错误信息
                return `# 文件读取失败\n\n无法读取文件 ${filename}，请确保文件存在于正确的路径中。\n\n错误信息: ${error.message}\n\n请检查以下可能的解决方案：\n1. 确保文件路径正确\n2. 确保文件存在\n3. 检查文件权限\n4. 确保服务器配置允许访问该文件`;
            }
        }
        
        // 使用AI处理文档
        async function processWithAI(docName, content, category) {
            let prompt;
            
            if (category === '产品说明') {
                prompt = `作为专业的中意人寿保险产品文档处理专家，请对以下产品说明文档进行标准化处理：

文档名称：${docName}
文档类型：中意人寿保险产品说明
原始内容：
${content}

请按照以下要求进行处理：

1. 产品信息结构化：
   - 产品名称和类型
   - 保障范围和责任
   - 投保条件和规则
   - 费率和缴费方式
   - 理赔流程和条件

2. 关键信息提取：
   - 适用人群和年龄范围
   - 保障金额和期限
   - 特色优势和卖点
   - 免责条款和限制

3. AI匹配优化：
   - 使用标准化保险术语
   - 明确产品分类标签
   - 便于客户需求匹配
   - 突出中意人寿品牌特色

请输出处理后的标准化产品说明文档：`;
            } else if (category === '销售话术') {
                prompt = `作为专业的中意人寿保险销售培训专家，请对以下销售话术文档进行标准化处理：

文档名称：${docName}
文档类型：中意人寿保险销售话术
原始内容：
${content}

请按照以下要求进行处理：

1. 话术场景分类：
   - 开场白和破冰话术
   - 需求挖掘和分析话术
   - 产品介绍和优势话术
   - 异议处理和解答话术
   - 促成签单和跟进话术

2. 内容优化整理：
   - 规范表达方式
   - 突出中意人寿优势
   - 增加说服力和亲和力
   - 符合保险行业规范

3. 实用性增强：
   - 提供具体话术模板
   - 标注使用场景和时机
   - 便于销售人员学习应用
   - 体现专业性和可信度

请输出处理后的标准化销售话术文档：`;
            } else {
                prompt = `作为专业的保险文档处理专家，请对以下中意人寿文档进行标准化处理：

文档名称：${docName}
原始内容：
${content}

请按照以下要求进行处理：

1. 结构化整理：
   - 统一格式和层级
   - 提取关键信息点
   - 规范术语表达

2. 内容优化：
   - 保留所有重要信息
   - 简化复杂表述
   - 增加逻辑连接

3. AI友好格式：
   - 使用标准化标签
   - 明确分类信息
   - 便于检索匹配
   - 突出中意人寿特色

请输出处理后的标准化文档内容：`;
            }
            
            const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: apiConfig.model,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.3,
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // 更新产品库
        function updateProductDatabase() {
            const productDatabase = [];
            
            // 收集所有已处理的文档
            Object.keys(documentCategories).forEach(category => {
                const categoryData = documentCategories[category];
                if (categoryData.documents) {
                    categoryData.documents.forEach(doc => {
                        if (doc.status === 'completed' && doc.processedContent) {
                            productDatabase.push({
                                originalName: doc.name,
                                originalFile: doc.file,
                                type: categoryData.name,
                                category: category,
                                processedContent: doc.processedContent,
                                processedAt: doc.processedAt,
                                uploadedAt: doc.uploadedAt
                            });
                        }
                    });
                }
            });
            
            localStorage.setItem('product_database', JSON.stringify(productDatabase));
            addLog(`产品库已更新，包含 ${productDatabase.length} 个处理完成的文档`, 'success');
        }
        
        // 查看文档
        function viewDocument(category, index) {
            const categoryData = documentCategories[category];
            if (!categoryData || !categoryData.documents || !categoryData.documents[index]) {
                showNotification('文档不存在', 'error');
                return;
            }
            
            const doc = categoryData.documents[index];
            const newWindow = window.open('', '_blank');
            
            let content = '';
            if (doc.status === 'completed' && doc.processedContent) {
                content = `
                    <h2>处理后内容：</h2>
                    <pre>${doc.processedContent}</pre>
                    <h2>原始内容：</h2>
                    <pre>${doc.content || '原始内容不可用'}</pre>
                `;
            } else {
                content = `
                    <h2>原始内容：</h2>
                    <pre>${doc.content || '内容不可用'}</pre>
                `;
            }
            
            newWindow.document.write(`
                <html>
                    <head>
                        <title>${doc.name}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                            .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
                            h1 { color: #333; border-bottom: 2px solid #007aff; padding-bottom: 10px; }
                            pre { background: #f8f8f8; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
                            .status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1>${doc.name}</h1>
                            <p><strong>类型：</strong>${categoryData.name}</p>
                            <p><strong>文件：</strong>${doc.file}</p>
                            <p><strong>状态：</strong><span class="status">${getStatusText(doc.status)}</span></p>
                            <p><strong>上传时间：</strong>${doc.uploadedAt ? new Date(doc.uploadedAt).toLocaleString('zh-CN') : '未知'}</p>
                            ${doc.processedAt ? `<p><strong>处理时间：</strong>${new Date(doc.processedAt).toLocaleString('zh-CN')}</p>` : ''}
                            ${content}
                        </div>
                    </body>
                </html>
            `);
        }
        
        // 下载处理结果
        function downloadProcessed(category, index) {
            const categoryData = documentCategories[category];
            if (!categoryData || !categoryData.documents || !categoryData.documents[index]) {
                showNotification('文档不存在', 'error');
                return;
            }
            
            const doc = categoryData.documents[index];
            if (doc.status !== 'completed' || !doc.processedContent) {
                showNotification('该文档尚未处理完成', 'warning');
                return;
            }
            
            const filename = `${doc.name}_处理结果.txt`;
            const content = `${doc.name}\n类型：${categoryData.name}\n处理时间：${new Date(doc.processedAt).toLocaleString('zh-CN')}\n\n${doc.processedContent}`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('文档已下载', 'success');
        }
        
        // 更新进度
        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }
        
        // 更新状态
        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }
        
        // 添加日志
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString('zh-CN');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-message log-${type}">${message}</span>
            `;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // 清空日志
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 设置面板功能
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('show');
        }
        
        
        // 调节背景亮度
        function adjustBrightness() {
            const slider = document.getElementById('brightnessSlider');
            const value = slider.value;
            const overlay = document.getElementById('brightnessOverlay');
            const valueDisplay = document.getElementById('brightnessValue');
            
            // 计算透明度（0-100转换为0.9-0）
            const opacity = (100 - value) / 100 * 0.9;
            overlay.style.opacity = opacity;
            
            valueDisplay.textContent = value + '%';
            
            // 保存设置
            localStorage.setItem('background_brightness', value);
        }
        
        // 重置设置
        function resetSettings() {
            // 重置亮度
            document.getElementById('brightnessSlider').value = 50;
            document.getElementById('brightnessValue').textContent = '50%';
            document.getElementById('brightnessOverlay').style.opacity = 0.5;
            
            // 清除本地存储
            localStorage.removeItem('background_brightness');
            
            showNotification('设置已重置', 'success');
        }
        
        // 加载保存的设置
        function loadSettings() {
            // 加载亮度设置
            const savedBrightness = localStorage.getItem('background_brightness');
            if (savedBrightness) {
                const slider = document.getElementById('brightnessSlider');
                slider.value = savedBrightness;
                document.getElementById('brightnessValue').textContent = savedBrightness + '%';
                
                const opacity = (100 - savedBrightness) / 100 * 0.9;
                document.getElementById('brightnessOverlay').style.opacity = opacity;
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadDocumentCategories();
            refreshDocuments();
            loadSettings();
        });
    </script>
    <script src="common.js"></script>
    <script>
        
        // 点击外部关闭设置面板
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('settingsPanel');
            const toggle = document.querySelector('.settings-toggle');
            
            if (!panel.contains(e.target) && !toggle.contains(e.target)) {
                panel.classList.remove('show');
            }
        });
    </script>
</body>
</html>